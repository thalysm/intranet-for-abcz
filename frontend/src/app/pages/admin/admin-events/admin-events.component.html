<div class="min-h-screen bg-stone-50">
  <app-admin-navbar></app-admin-navbar>

  <div class="container mx-auto px-4 py-12">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-4">
      <div>
        <h1 class="text-4xl font-serif font-bold text-stone-800 mb-2">
          Gerenciar Eventos
        </h1>
        <p class="text-stone-600 text-lg">
          Crie eventos e envie notificações para os associados
        </p>
      </div>
      <button (click)="openCreateModal()"
        class="px-6 py-3 bg-primary text-white font-medium rounded-sm hover:bg-primary/90 transition-colors shadow-sm flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Criar Evento
      </button>
    </div>

    <!-- Events list -->
    <div class="space-y-6">
      @for (event of events; track event.id) {
      <div class="bg-white border border-stone-200 rounded-sm p-6 hover:shadow-md transition-shadow duration-200">
        <div class="flex flex-col md:flex-row justify-between items-start gap-6">
          <div class="flex-1">
            <h3 class="text-2xl font-bold text-stone-800 mb-3">
              {{ event.title }}
            </h3>
            <p class="text-stone-600 mb-6 leading-relaxed">
              {{ event.description }}
            </p>

            <div class="flex flex-wrap gap-6 text-sm text-stone-500">
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span>{{ event.eventDate | date : "dd/MM/yyyy HH:mm" }}</span>
              </div>
              <div class="flex items-center gap-2">
                <svg class="w-5 h-5 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>{{ event.location }}</span>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap gap-3 w-full md:w-auto">
            <button (click)="viewReport(event.id)"
              class="px-4 py-2 bg-blue-50 text-blue-700 font-medium rounded-sm hover:bg-blue-100 transition-colors flex items-center gap-2 flex-1 md:flex-none justify-center">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Relatório
            </button>
            <button (click)="editEvent(event)"
              class="px-4 py-2 bg-stone-100 text-stone-700 font-medium rounded-sm hover:bg-stone-200 transition-colors flex items-center gap-2 flex-1 md:flex-none justify-center">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
              </svg>
              Editar
            </button>
            <button (click)="deleteEvent(event.id)"
              class="px-4 py-2 bg-red-50 text-red-700 font-medium rounded-sm hover:bg-red-100 transition-colors flex items-center gap-2 flex-1 md:flex-none justify-center">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Excluir
            </button>
          </div>
        </div>

        <!-- Summary -->
        @if (event.confirmations && event.confirmations.length > 0) {
        <div class="mt-6 pt-6 border-t border-stone-100">
          <div class="flex flex-wrap gap-6 text-sm font-medium">
            <span class="text-green-600 flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
              {{ getConfirmedCount(event) }} confirmados
            </span>
            <span class="text-red-600 flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              {{ getDeclinedCount(event) }} recusaram
            </span>
            <span class="text-stone-400 flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              {{ getPendingCount(event) }} pendentes
            </span>
          </div>
        </div>
        }
      </div>
      } @if (events.length === 0) {
      <div class="bg-white border border-stone-200 rounded-sm p-12 text-center">
        <div class="w-16 h-16 bg-stone-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-bold text-stone-800 mb-2">
          Nenhum evento criado
        </h3>
        <p class="text-stone-500 mb-6">
          Comece criando o primeiro evento para os associados.
        </p>
        <button (click)="openCreateModal()"
          class="px-6 py-3 bg-primary text-white font-medium rounded-sm hover:bg-primary/90 transition-colors">
          Criar Primeiro Evento
        </button>
      </div>
      }
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
@if (showModal) {
<div class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity"
  (click)="closeModal()">
  <div
    class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all scale-100"
    (click)="$event.stopPropagation()">
    <div class="p-6 md:p-8">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-stone-100">
        <h2 class="text-2xl font-serif font-bold text-stone-800">
          {{ editingEvent ? "Editar Evento" : "Criar Novo Evento" }}
        </h2>
        <button (click)="closeModal()"
          class="text-stone-400 hover:text-stone-600 transition-colors p-2 hover:bg-stone-100 rounded-full">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <form [formGroup]="eventForm" (ngSubmit)="onSubmit()">
        <!-- AI Generation -->
        <div class="bg-purple-50 p-4 md:p-6 rounded-lg border border-purple-100 mb-6">
          <h3 class="font-bold text-purple-800 mb-3 flex items-center gap-2 text-sm md:text-base">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Preencher com IA
          </h3>
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" [(ngModel)]="aiPrompt" [ngModelOptions]="{standalone: true}"
              placeholder="Ex: Churrasco de confraternização dia 20/12 as 18h na sede"
              class="flex-1 px-4 py-2.5 border border-purple-200 rounded-md focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 outline-none text-sm md:text-base">
            <button type="button" (click)="generateWithAI()" [disabled]="isGenerating || !aiPrompt"
              class="px-5 py-2.5 bg-purple-600 text-white font-medium rounded-md hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center justify-center gap-2 whitespace-nowrap">
              @if (isGenerating) {
              <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
              </svg>
              } @else {
              <span>Gerar</span>
              }
            </button>
          </div>
        </div>

        <div class="space-y-5">
          <div>
            <label class="block text-sm font-medium text-stone-700 mb-1.5">Título</label>
            <input type="text" formControlName="title"
              class="w-full px-4 py-2.5 border border-stone-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
              placeholder="Ex: Reunião Mensal" />
          </div>

          <div>
            <label class="block text-sm font-medium text-stone-700 mb-1.5">Descrição</label>
            <textarea formControlName="description" rows="4"
              class="w-full px-4 py-2.5 border border-stone-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
              placeholder="Descreva o evento..."></textarea>
          </div>

          <div class="grid md:grid-cols-2 gap-5">
            <div>
              <label class="block text-sm font-medium text-stone-700 mb-1.5">Data e Hora</label>
              <input type="datetime-local" formControlName="eventDate"
                class="w-full px-4 py-2.5 border border-stone-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all" />
            </div>

            <div>
              <label class="block text-sm font-medium text-stone-700 mb-1.5">Local</label>
              <input type="text" formControlName="location"
                class="w-full px-4 py-2.5 border border-stone-300 rounded-md focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all"
                placeholder="Ex: Sede ABCZ" />
            </div>
          </div>

          @if (!editingEvent) {
          <div class="bg-stone-50 p-5 rounded-lg border border-stone-100">
            <h3 class="font-bold text-stone-800 mb-3 flex items-center gap-2 text-sm md:text-base">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
              </svg>
              Notificações via WhatsApp
            </h3>

            <div class="mb-3">
              <label class="flex items-center gap-3 cursor-pointer select-none">
                <input type="checkbox" formControlName="notifyAll"
                  class="w-5 h-5 text-primary rounded border-stone-300 focus:ring-primary" />
                <span class="text-stone-700 font-medium">Enviar para todos os associados</span>
              </label>
            </div>

            @if (!eventForm.get('notifyAll')?.value) {
            <div class="mt-4 animate-fadeIn">
              <label class="block text-sm font-medium text-stone-700 mb-2">Selecionar associados</label>
              <div class="bg-white border border-stone-300 rounded-md p-2 max-h-48 overflow-y-auto">
                @for (user of users; track user.id) {
                <label
                  class="flex items-center gap-3 p-2.5 hover:bg-stone-50 rounded-sm cursor-pointer transition-colors border-b border-stone-100 last:border-0">
                  <input type="checkbox" [checked]="isUserSelected(user.id)" (change)="toggleUserSelection(user.id)"
                    class="w-4 h-4 text-primary rounded border-stone-300 focus:ring-primary" />
                  <span class="text-stone-700 text-sm">
                    {{ user.name }}
                    <span class="text-stone-400 text-xs">({{ user.matricula }})</span>
                  </span>
                </label>
                }
              </div>
            </div>
            }
          </div>
          }
        </div>

        <div class="flex gap-3 mt-8 pt-6 border-t border-stone-100">
          <button type="button" (click)="closeModal()"
            class="px-6 py-2.5 bg-stone-100 text-stone-700 font-medium rounded-md hover:bg-stone-200 transition-colors flex-1">
            Cancelar
          </button>
          <button type="submit" [disabled]="eventForm.invalid || isSubmitting"
            class="px-6 py-2.5 bg-primary text-white font-medium rounded-md hover:bg-primary/90 transition-colors flex-1 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm">
            {{
            isSubmitting
            ? "Salvando..."
            : editingEvent
            ? "Atualizar Evento"
            : "Criar e Notificar"
            }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}

<!-- Report Modal -->
@if (showReportModal && selectedReport) {
<div class="fixed inset-0 bg-stone-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-sm shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="p-8">
      <div class="flex justify-between items-center mb-8 pb-4 border-b border-stone-100">
        <h2 class="text-2xl font-serif font-bold text-stone-800">
          Relatório de Presença
        </h2>
        <button (click)="closeReportModal()" class="text-stone-400 hover:text-stone-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Summary -->
      <div class="grid md:grid-cols-4 gap-4 mb-8">
        <div class="bg-blue-50 p-4 rounded-sm border border-blue-100 text-center">
          <div class="text-3xl font-bold text-blue-700 mb-1">
            {{ selectedReport.totalSent }}
          </div>
          <div class="text-sm text-blue-600 font-medium uppercase tracking-wide">
            Enviados
          </div>
        </div>
        <div class="bg-green-50 p-4 rounded-sm border border-green-100 text-center">
          <div class="text-3xl font-bold text-green-700 mb-1">
            {{ selectedReport.confirmed }}
          </div>
          <div class="text-sm text-green-600 font-medium uppercase tracking-wide">
            Confirmados
          </div>
        </div>
        <div class="bg-red-50 p-4 rounded-sm border border-red-100 text-center">
          <div class="text-3xl font-bold text-red-700 mb-1">
            {{ selectedReport.declined }}
          </div>
          <div class="text-sm text-red-600 font-medium uppercase tracking-wide">
            Recusaram
          </div>
        </div>
        <div class="bg-stone-50 p-4 rounded-sm border border-stone-200 text-center">
          <div class="text-3xl font-bold text-stone-600 mb-1">
            {{ selectedReport.pending }}
          </div>
          <div class="text-sm text-stone-500 font-medium uppercase tracking-wide">
            Pendentes
          </div>
        </div>
      </div>

      <!-- Details -->
      <h3 class="font-bold text-stone-800 mb-4 text-lg">
        Detalhes por Associado
      </h3>
      <div class="border border-stone-200 rounded-sm overflow-hidden">
        <table class="w-full">
          <thead class="bg-stone-50 border-b border-stone-200">
            <tr>
              <th class="px-6 py-4 text-left text-sm font-bold text-stone-600 uppercase tracking-wider">
                Nome
              </th>
              <th class="px-6 py-4 text-left text-sm font-bold text-stone-600 uppercase tracking-wider">
                Status
              </th>
              <th class="px-6 py-4 text-left text-sm font-bold text-stone-600 uppercase tracking-wider">
                Data Resposta
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-stone-100 bg-white">
            @for (detail of selectedReport.details; track detail.id) {
            <tr class="hover:bg-stone-50 transition-colors">
              <td class="px-6 py-4 text-sm font-medium text-stone-800">
                {{ detail.userName }}
              </td>
              <td class="px-6 py-4 text-sm">
                @if (detail.status === 1) {
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Confirmado</span>
                } @else if (detail.status === 2) {
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Recusou</span>
                } @else {
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-stone-100 text-stone-800">Pendente</span>
                }
              </td>
              <td class="px-6 py-4 text-sm text-stone-500">
                {{ detail.responseDate | date : "dd/MM/yy HH:mm" }}
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="mt-8 pt-6 border-t border-stone-100 flex justify-end">
        <button (click)="closeReportModal()"
          class="px-6 py-3 bg-stone-100 text-stone-700 font-medium rounded-sm hover:bg-stone-200 transition-colors">
          Fechar Relatório
        </button>
      </div>
    </div>
  </div>
</div>
}